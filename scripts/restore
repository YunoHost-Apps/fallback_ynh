#!/bin/bash

#=================================================
# GENERIC START
#=================================================
# IMPORT GENERIC HELPERS
#=================================================

if [ ! -e _common.sh ]; then
	# Get the _common.sh file if it's not in the current directory
	cp ../settings/scripts/_common.sh ./_common.sh
	chmod a+rx _common.sh
fi
source _common.sh
source /usr/share/yunohost/helpers

#=================================================
# MANAGE SCRIPT FAILURE
#=================================================

# Exit if an error occurs during the execution of the script
ynh_abort_if_errors

#=================================================
# LOAD SETTINGS
#=================================================

app=$YNH_APP_INSTANCE_NAME

install_type=$(ynh_app_setting_get $app install_type)
encrypt=$(ynh_app_setting_get $app encrypt)
final_path=$(ynh_app_setting_get $app final_path)
ssh_host=$(ynh_app_setting_get $app ssh_host)
ssh_port=$(ynh_app_setting_get $app ssh_port)

#=================================================
# CHECK IF THE APP CAN BE RESTORED
#=================================================

test ! -d $final_path \
	|| ynh_die "There is already a directory: $final_path "

#=================================================
# STANDARD RESTORATION STEPS
#=================================================
# RESTORE THE APP MAIN DIR
#=================================================

ynh_restore_file "$final_path"

#=================================================
# SPECIFIC RESTORATION
#=================================================
# REINSTALL DEPENDENCIES
#=================================================

# Define and install dependencies
ynh_install_app_dependencies ccrypt rsync mlocate

if [ "$install_type" == "main" ]
then

	#=================================================
	# ADD THE HOST TO THE KNOWN HOST LIST
	#=================================================

	mkdir -p /root/.ssh
	ssh-keyscan -t rsa $ssh_host >> /root/.ssh/known_hosts 2> /dev/null

	#=================================================
	# RESTORE LOGROTATE
	#=================================================

	ynh_restore_file "/etc/logrotate.d/$app"

	#=================================================
	# RESTORE THE CRON FILE
	#=================================================

	ynh_restore_file "/etc/cron.d/$app"

else
	#=================================================
	# RECREATE DEDICATED USER
	#=================================================

	if ! ynh_system_user_exists "$app"
	then
		useradd -d "/home/$app" --system --user-group $app --shell /bin/bash
	fi

	#=================================================
	# RESTORE USER DIRECTORIES
	#=================================================

	ynh_restore_file "/home/$app/bin"
	ynh_restore_file "/home/$app/lib"
	ynh_restore_file "/home/$app/lib64"
	ynh_restore_file "/home/$app/.ssh"

	# Update the ssh config
	if ! grep "# Automatically added by $app" /etc/ssh/sshd_config
	then
		echo "
		Match User $app # Automatically added by $app
		ChrootDirectory /home/%u # Automatically added by $app
		AllowTcpForwarding no # Automatically added by $app
		X11Forwarding no # Automatically added by $app" >> /etc/ssh/sshd_config

		# Reload ssh service
		systemctl reload ssh
	fi
fi

#=================================================
# RECREATE DIRECTORIES
#=================================================

mkdir -p "/home/yunohost.app/$app/fallback_backup/backup"
if [ "$install_type" == "main" ]
then
	mkdir -p /var/log/$app
else
	mkdir -p /home/$app/backup
fi

#=================================================
# SET LINKS FOR THE ADMIN USER
#=================================================

if [ "$install_type" == "main" ]; then
	ln -sf "$final_path/send_process/app_list" "/home/yunohost.app/$app/app_list"
	ln -sf "$final_path/send_process/config.conf" "/home/yunohost.app/$app/config.conf"
	ln -sf "$final_path/update_from_fallback_process/update_from_fallback.sh" "/home/yunohost.app/$app/update_from_fallback"
else
	ln -sf "$final_path/deploy_process/deploy_fallback.sh" "/home/yunohost.app/$app/deploy_fallback"
	ln -sf "$final_path/deploy_process/close_fallback.sh" "/home/yunohost.app/$app/close_fallback"
fi

#=================================================
# GENERIC FINALIZATION
#=================================================
# SECURE FILES AND DIRECTORIES
#=================================================

if [ "$install_type" == "fallback" ]
then
	# The parent directory shall belong to root
	chown $app: -R "/home/$app"
	chown root: "/home/$app"
fi
